---
title: "Untitled"
output: html_document
date: "2024-10-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(RCurl)
library(tidyverse)
library(XML)
library(xml2)
library(rvest)
library(readxl)
library(openxlsx)
```


```{r}
# make folder all in rds for saving data frame

dir.create("../rds/oral/prf",
             showWarnings = TRUE, recursive = FALSE, mode = "0777")

dir.create("../rds/ext/prf",
             showWarnings = TRUE, recursive = FALSE, mode = "0777")

dir.create("../rds/inj/prf",
             showWarnings = TRUE, recursive = FALSE, mode = "0777")

```

```{r}
# get folder names

oral_folder <- list.files("../xlsx/oral") %>% str_subset("[^parse]")

oral_folder
```

```{r}
#dir.create("../rds/parse/12",
#             showWarnings = TRUE, recursive = FALSE, mode = "0777")

#dir.create("../rds/parse/39",
#             showWarnings = TRUE, recursive = FALSE, mode = "0777")
```


# read first two files

```{r}
get_data_prf_1 <- function(xlsx_path){
  
  # read excel sheet
  df <- read.xlsx(xlsx_path, startRow = 4,
                 fillMergedCells = FALSE) 
  
    # get sheet name
  sheet_name <- getSheetNames(xlsx_path)
  
  # clean colnames
  colnames(df)[1:8] <- c("CLASS_code", "CLASS_name",
                       "DRUG_code", "DRUG_name",
                       "COST_code", "COST_per",
                       "GEN", "TOTAL")
  
  # add file name
  df <- df %>% mutate(FILE_ori = xlsx_path) %>%
    mutate(FILE = str_extract(FILE_ori, "(?<=\\/)00[:digit:]+(?=\\.xlsx)")) %>%
    relocate(FILE, .before = "CLASS_code")
  
  # add sheet name and type
  df <- df %>% mutate(SHEET_jp = sheet_name) %>%
    mutate(TYPE = case_when(str_detect(SHEET_jp, "内服")　~ "oral",
                            str_detect(SHEET_jp, "外用") ~ "ext",
                            str_detect(SHEET_jp, "注射") ~ "inj")) %>%
    relocate(TYPE, .after = "FILE")
    
  
  # add category: dem
  df <- df %>% 
    mutate(CAT = "prf") %>%
    relocate(CAT, .after = "TYPE") 
  
  # add sheet
  df <- df %>%
    mutate(SHEET = case_when(str_detect(SHEET_jp, "外来")　&
                               str_detect(SHEET_jp, "院内")~ "outpt_inpr",
                             str_detect(SHEET_jp, "外来")　&
                               str_detect(SHEET_jp, "院外")~ "outpt_outpr",
                             str_detect(SHEET_jp, "入院") ~ "inpt")) %>%
    relocate(SHEET, .after = "CAT")

  # add sheet
  df <- df %>% select(!FILE_ori)
  
  df <- df %>%
    tidyr::fill(starts_with("CLASS_"), .direction = "down")
  
     # process year
  # function for converting year into Western year
  convert_year <- function(x){
  if (str_detect(x, "^H")){
    y <- x %>% str_remove("^H") %>% as.numeric()
    y <- y + 1988
    return(as.character(y))
  }
  else if (str_detect(x, "^R")){
    y <- x %>% str_remove("^R") %>% as.numeric()
    y <- y + 2018
    return(as.character(y))
  }
  else{
    return(x)
  }
}
  
  # create function for getting year
  get_year <- function(x, y){
  read.xlsx(x, sheet = y, startRow = 1 , colNames = FALSE, rows = 1) %>% 
    rename(DES_jp = "X1") %>%
    mutate(FILE = x) %>%
    mutate(FILE = str_extract(FILE, "(?<=\\/)00[:digit:]+(?=\\.xlsx)")) %>%
    mutate(DES_jp = str_remove(DES_jp, "　※.+") )  %>%
    mutate(DES_jp = str_remove(DES_jp, "診療年月："))　%>%
    mutate(YEAR_str = str_extract(DES_jp, "[^年]+(?=年)")) %>%
    mutate(YEAR_end = str_extract(DES_jp, "(?<=～)[^年]+(?=年)")) %>%
    mutate(YEAR_str = convert_year(YEAR_str)) %>%
    mutate(YEAR_end = convert_year(YEAR_end))
    }
  
  # get df for year
  df_year <- get_year(xlsx_path)
    
  df <- df %>% left_join(df_year, by = join_by(FILE))
  
  
  df <- df %>% mutate(across(everything(), as.character))
  
  return(df)

  }
```

```{r}
# for each folider, read the first two files, parse , combine and save
# x is the overall folder name (oral ext inj)
# y is the individual folder

save_df_prf_1 <- function(x, y){
  xlsx <- list.files(paste0("../xlsx/", x, "/", y))
  
  xlsx <- xlsx[1:2]
  
  from <- paste0("../xlsx/", x, "/", y, "/", xlsx)
  
  df <- map(from, get_data_prf_1) %>% list_rbind()
  
  saveRDS(df, paste0("../rds/", x, "/", "prf/", "df_", x, "_", y, "_1"))
}
```

```{r}
oral_prf <-  oral_folder %>% str_subset("prf")

oral_prf
```

```{r}
#list.files(paste0("../xlsx/", "oral", "/", oral_dem_xlsx[1]))
```

```{r}
# save file 1 and 2
for (i in 1:length(oral_prf)){
  save_df_prf_1("oral", oral_prf[i])
  print(paste0(oral_prf[i], "_1", " completed"))
}
```

```{r}
df_ex <- readRDS("../rds/oral/prf/df_oral_inpt_prf_1")
```


# save 3-9

```{r}
get_data_prf_2 <- function(xlsx_path){
  
  # read excel sheet
  df <- read.xlsx(xlsx_path, startRow = 4,
                 fillMergedCells = FALSE) 
  
  # get sheet name
  sheet_name <- getSheetNames(xlsx_path)
  
  # clean colnames
  colnames(df)[1:9] <- c("CLASS_code", "CLASS_name",
                       "DRUG_code", "DRUG_name", "UNIT",
                       "COST_code", "COST_per",
                       "GEN", "TOTAL")
  
    # add file name
  df <- df %>% mutate(FILE_ori = xlsx_path) %>%
    mutate(FILE = str_extract(FILE_ori, "(?<=\\/)00[:digit:]+(?=\\.xlsx)")) %>%
    relocate(FILE, .before = "CLASS_code")
  
   # add sheet name and type
  df <- df %>% mutate(SHEET_jp = sheet_name) %>%
    mutate(TYPE = case_when(str_detect(SHEET_jp, "内服")　~ "oral",
                            str_detect(SHEET_jp, "外用") ~ "ext",
                            str_detect(SHEET_jp, "注射") ~ "inj")) %>%
    relocate(TYPE, .after = "FILE")
    
  
  # add category: dem
  df <- df %>% 
    mutate(CAT = "prf") %>%
    relocate(CAT, .after = "TYPE") 
  
  # add sheet
  df <- df %>%
    mutate(SHEET = case_when(str_detect(SHEET_jp, "外来")　&
                               str_detect(SHEET_jp, "院内")~ "outpt_inpr",
                             str_detect(SHEET_jp, "外来")　&
                               str_detect(SHEET_jp, "院外")~ "outpt_outpr",
                             str_detect(SHEET_jp, "入院") ~ "inpt")) %>%
    relocate(SHEET, .after = "CAT")

  # add sheet
  df <- df %>% select(!FILE_ori)
  
  # fill empty cells in CLASS columns
  df <- df %>%
    tidyr::fill(starts_with("CLASS_"), .direction = "down")
  
  
      # process year
  # function for converting year into Western year
  convert_year <- function(x){
  if (str_detect(x, "^H")){
    y <- x %>% str_remove("^H") %>% as.numeric()
    y <- y + 1988
    return(as.character(y))
  }
  else if (str_detect(x, "^R")){
    y <- x %>% str_remove("^R") %>% as.numeric()
    y <- y + 2018
    return(as.character(y))
  }
  else{
    return(x)
  }
}
  
  # create function for getting year
  get_year <- function(x, y){
  read.xlsx(x, sheet = y, startRow = 1 , colNames = FALSE, rows = 1) %>% 
    rename(DES_jp = "X1") %>%
    mutate(FILE = x) %>%
    mutate(FILE = str_extract(FILE, "(?<=\\/)00[:digit:]+(?=\\.xlsx)")) %>%
    mutate(DES_jp = str_remove(DES_jp, "　※.+") )  %>%
    mutate(DES_jp = str_remove(DES_jp, "診療年月："))　%>%
    mutate(YEAR_str = str_extract(DES_jp, "[^年]+(?=年)")) %>%
    mutate(YEAR_end = str_extract(DES_jp, "(?<=～)[^年]+(?=年)")) %>%
    mutate(YEAR_str = convert_year(YEAR_str)) %>%
    mutate(YEAR_end = convert_year(YEAR_end))
    }
  
  # get df for year
  df_year <- get_year(xlsx_path)
    
  df <- df %>% left_join(df_year, by = join_by(FILE))
  
  
  # convert everything to character for now
  df <- df %>% mutate(across(everything(), as.character))
  
  return(df)

  }
```


```{r}
# for each folider, read the first two files, parse , combine and save
# x is the overall folder name (oral ext inj)
# y is the individual folder

save_df_prf_2 <- function(x, y){
  xlsx <- list.files(paste0("../xlsx/", x, "/", y))
  
  xlsx <- xlsx[3:10]
  
    from <- paste0("../xlsx/", x, "/", y, "/", xlsx)
  
  df <- map(from, get_data_prf_2) %>% list_rbind()
  
  saveRDS(df, paste0("../rds/", x, "/", "prf/", "df_", x, "_", y, "_2"))
}
```


```{r}
# save file 3 and 9
for (i in 1:length(oral_prf)){
  save_df_prf_2("oral", oral_prf[i])
  print(paste0(oral_prf[i], "_2", " completed"))
}
```

# example

```{r}
df_ex <- readRDS("../rds/oral/prf/df_oral_inpt_prf_1")

df_ex_2 <- readRDS("../rds/oral/prf/df_oral_inpt_prf_2")
```

```{r}
df_ex %>% count(SHEET)
```


```{r}
df_ex %>% count(SHEET)
```
```{r}
df_ex_2 %>% count(SHEET)
```

