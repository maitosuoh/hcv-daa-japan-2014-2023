---
title: "HCV DAA"
output: html_document
date: "2025-11-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(openxlsx)

library(rnaturalearth)
```

```{r}
# make df folder

dir.create("../df/format", showWarnings = TRUE, recursive = FALSE, mode = "0777")
```

# read files

```{r}
files_long <- list.files("../df/daa/long", pattern = "daa") 

files_long
```

```{r}
path_long <- paste0("../df/daa/long/", files_long)

path_long
```

```{r}
for (i in 1:length(path_long)){
  assign(files_long[i], readRDS(path_long[i]))
}
```



```{r}
df_daa_dem_1_long <- df_daa_dem_1_long %>%
  mutate(AGE = str_replace_all(AGE, "_", "-"))

df_daa_dem_2_long  <- df_daa_dem_2_long %>%
  mutate(AGE = str_replace_all(AGE, "_", "-"))
```


# dem

```{r}
fct_age_1 <- df_daa_dem_1_long %>% distinct(AGE) %>% pull(AGE)

fct_age_1

length(fct_age_1)
```


```{r}
# check age 39

df_daa_dem_2_long %>% distinct(AGE) %>% pull(AGE)

```

# format age in dem 3-9
# change "90_94" "95_99" "100_" to "90_" to be consisent with 12 

```{r}
df_daa_dem_2_long <- df_daa_dem_2_long %>% 
  mutate(AGE = fct_other(AGE,
                         keep = as.character(fct_age_1[1:18]),
                         other_level = "90-"))
```



```{r}
df_daa_dem <- df_daa_dem_1_long %>%
  bind_rows(df_daa_dem_2_long) %>%
  mutate(AGE = factor(AGE, levels = fct_age_1)) %>%
  mutate(SEX = factor(SEX, levels = c("M", "F"))) %>%
  mutate(across(c(TOTAL, VALUE), ~ replace_na(.x, 0))) %>%
  mutate(across(c(TOTAL, VALUE, COST_per), ~ as.numeric(.x)))
```

```{r}
df_daa_dem %>%
  count(DRUG_name, YEAR_str)
```


```{r}
saveRDS(df_daa_dem, "../df/daa/format/df_daa_dem")
```


# prf

```{r}
df_prf <- rnaturalearth::ne_states("japan") %>% 
  as_tibble() %>%
  select(iso_3166_2, name_ja, name_en) %>%
  rename(PRF_jp = "name_ja",
         PRF= "name_en") %>%
  arrange(iso_3166_2)
```

```{r}
df_prf <- df_prf %>%
  mutate(PRF = str_remove(PRF, "Prefecture")) %>%
  mutate(PRF = str_trim(PRF, side = "both")) %>%
  mutate(PRF = str_replace_all(PRF, "Ō", "O")) %>%
  mutate(PRF = str_replace_all(PRF, "ō", "o"))
```


```{r}
df_daa_prf <- df_daa_prf_1_long %>%
  bind_rows(df_daa_prf_2_long) %>%
  mutate(across(c(TOTAL, VALUE), ~ replace_na(.x, 0))) %>%
  mutate(across(c(TOTAL, VALUE, COST_per), ~ as.numeric(.x))) %>%
  rename(PRF_jp = "PRF")
```


```{r}
df_daa_prf <- df_daa_prf %>%
  left_join(df_prf,
            by = join_by(PRF_jp))
```

```{r}
saveRDS(df_daa_prf, "../df/daa/format/df_daa_prf")
```


# end of run

